<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title> Building A Javascript Event System</title><meta name="viewport" content="width=device-width"><meta name="description" content="Talon lives."><link rel="canonical" href="theghostin.me/2014/10/17/building-a-JavaScript-event-system/"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/animate.css"></head><body><div class="out-wrap"> <a href="/blog"> <img id="omni-ghost" class="site-icon tilty" src="/assets/ghost-circle.png" width=100  height=100 /> </a><div class="wrap-content"><div class="post"><header class="post-header"><h1>Building A Javascript Event System</h1><p class="meta">Oct 17, 2014</p> </header><article class="post-content"><p>Demystifying JavaScript events by building an event system from scratch.</p><p>The event pattern is a great way to add extensibility and flexibility to your libraries and frameworks. Simply by emitting events on key actions inside your code you can allow users of your module to apply their own desired behavior without having to modify the module itself.</p><p>We will take a look at the event pattern by building an event system from scratch.</p><h2 id="the-api">The API</h2><p>Here’s what we’re building will look like.</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'event'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="c1">// hello</span>
<span class="p">})</span>
<span class="nx">events</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'event'</span><span class="p">,</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="s1">'hello'</span><span class="p">})</span></code></pre></div><h2 id="the-essence-of-the-problem">The Essence of the Problem</h2><p>If we distill events down to their core we discover that an event is nothing more than a <code>string</code>, or as we will call it in this post the namespace, and an <code>array</code> of <code>functions</code> attached to it.</p><p>So how do we,</p><ul><li>associate <code>strings</code> with an <code>array</code> of <code>functions</code>?</li><li>add <code>functions</code> to an <code>array</code>?</li><li>call each <code>function</code> in an <code>array</code> and also pass each one the same arguments?</li></ul><h2 id="module">Module</h2><p>To make our event system usable across a wide variety of libraries and frameworks we will define it as an object and, in this example, export so that it can be used with <a href="http://browserify.org">browserify</a> or <a href="http://nodejs.org">node</a>. The rest of this post will assume that we are augmenting the <code>events</code> objects.</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">events</span></code></pre></div><h2 id="key-value-yo">Key value, yo</h2><p>Using a plain <code>object</code> is an elegant way to accomplish our first problem of associating namespaces with an <code>array</code> of <code>functions</code>. We can imagine the <code>object</code> will follow this schema:</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s1">'event'</span><span class="o">:</span> <span class="p">[</span><span class="nx">fnOne</span><span class="p">,</span> <span class="nx">fnTwo</span><span class="p">,</span> <span class="nx">fnThree</span><span class="p">],</span>
  <span class="s1">'event-two'</span><span class="o">:</span> <span class="p">[</span><span class="nx">diffFnOne</span><span class="p">,</span> <span class="nx">diffFnTwo</span><span class="p">,</span> <span class="nx">diffFnThree</span><span class="p">]</span>
<span class="p">}</span></code></pre></div><p>To achieve this format we will simply define a property on our <code>object</code> called <code>events</code> that is an empty object. This will become more clear later. Think of this as a container for events.</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="s1">'events'</span> <span class="p">{</span>
  <span class="nx">writable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">value</span><span class="o">:</span> <span class="p">{}</span>
<span class="p">})</span></code></pre></div><h2 id="push-it-baby">.push it baby</h2><p>JavaScript has a really neat feature that is often taken for granted, first-class functions. This means that <code>functions</code> can be stored in <code>variables</code>, passed around inside of other <code>functions</code> as <code>arguments</code> and otherwise treated as just regular data. This makes it really easy to create an <code>array</code> of <code>functions</code>. All we need to do is use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/push"><code>Array.prototype.push</code></a> <code>method</code> on an array and pass it the <code>function</code>!</p><p>To add a function to a namespace our <code>on</code> method should check if the namespace already exists as a key on the <code>events.events</code> object and if it doesn’t, add it. Then push the function to it.</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="s1">'on'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if it's not an array make it one.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span>
    <span class="c1">// then push the fn to it.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></div><p>Well that was easy. That’s our complete <code>.on</code> method!</p><h2 id="apply-those-functions">.apply those functions</h2><p>We’re going to get a little tricky here but it’ll be fun.</p><p>First thing is first, to loop through an array and get each <code>function</code> we’re going to use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach"><code>Array.prototype.forEach</code></a>. Then we’re going to call each <code>function</code> with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/prototype"><code>Function.prototype.apply</code></a> so that we can pass each function an array of arguments.</p><p>We will also utilize the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/arguments"><code>arguments</code></a> object in order to take all the values passed after the namespace in the <code>.emit</code> method and pass them to the functions as arguments.</p><p>The <code>arguments</code> object is an <code>array-like</code> object which means it’s virtually useless unless we convert it into a true array. We will use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice"><code>Array.prototype.slice</code></a> to convert it for us.</p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="s1">'emit'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">namespace</span> <span class="cm">/*, args */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if this namespace isn't an array or is empty don't do anything with it.</span>
    <span class="k">if</span> <span class="p">(</span>
         <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span>
      <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// turn this functions arguments object into a true array</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)</span>
    <span class="c1">// remove the first argument because that's the namespace</span>
    <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>

    <span class="c1">// loop through each function</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">namespace</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// the first argument to apply determines `this` inside the function it</span>
      <span class="c1">// it is applying. In our case, we don't care about it so we make it null.</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></div><h2 id="the-challenge">The Challenge</h2><p>We now have a working event system that can easily be added to other libraries and modules!</p><p>Here’s a challenge left to the reader: Concieve and implement a <code>.off</code> method that removes a specific function from a namespace.</p></article><div id="disqus_thread"></div> <script>var disqus_shortname="theghostinme";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div> <footer><p>hello</p> </footer><script src="http://code.jquery.com/jquery-2.1.1.min.js"></script><script src="/js/build.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43654314-7', 'auto');
  ga('send', 'pageview');

</script></div></body></html>