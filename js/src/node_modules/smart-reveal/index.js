(function(global, jQuery, factory) {

	if (typeof module === "object" && typeof module.exports === "object") {
		module.exports = factory(global, jQuery);
	} else {
		global.SmartReveal = factory(global, jQuery);
	}

}(
  typeof window !== "undefined" ? window : this,
  typeof jQuery !== "undefined" ? jQuery : require('jquery'),
  function(window, $, undefined) {

    var SmartReveal = function(el, opts) {
      opts = opts || {};

      this.$el = $(el);
      this.opts = opts || {};

      /**
       * Defaults options.
       */
      this.opts.thresholdDown = opts.thresholdDown || 50;
      this.opts.thresholdUp = opts.thresholdUp || 50;
      this.opts.scrollTimeout = opts.scrollTimeout || 250;

      if (typeof this.opts.transitionOut !== 'function') {
        this.opts.transitionOut = function($el) {
          $el.fadeOut(300);
        };
      }

      if (typeof this.opts.transitionIn !== 'function') {
        this.opts.transitionIn = function($el) {
          $el.fadeIn(300);
        };
      }

    };

    SmartReveal.prototype.lastScrollTop = {
      lastScrollTop: 0,
      get: function() {
        return this.lastScrollTop;
      },
      set: function(val) {
        this.lastScrollTop = val;
        return val;
      }
    };

    /**
     * Element hiding logic tied to `onscroll` event.
     */
    SmartReveal.prototype.smartReveal = function() {
      var self = this;

      $(window).scroll(function() {

        var $this = $(this);
        var delta = Math.abs($this.scrollTop() - self.lastScrollTop.get());
        var isDownScroll = $this.scrollTop() > self.lastScrollTop.get();

        /**
         * Scroll end.
         */
        clearTimeout($.data(this, 'scrollTimer'));
        $.data(this, 'scrollTimer', setTimeout(function() {
          self.lastScrollTop.set($this.scrollTop());
        }, self.opts.scrollTimeout));

        /**
         * Call transition.
         */
        if (isDownScroll && delta > self.opts.thresholdDown) {
          self.opts.transitionOut(self.$el);
        }
        if (!isDownScroll && delta > self.opts.thresholdUp) {
          self.opts.transitionIn(self.$el);
        }

      });
    };

    return SmartReveal;
}));
